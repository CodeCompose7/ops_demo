name: CD Pipeline

on:
  release:
    types: [published]

env:
  IMAGE_NAME: ops-demo

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú (Training & Serving & Controller)
        run: |
          VERSION=${{ github.event.release.tag_name }}

          # Training Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
          echo "üî® Training Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Ï§ë..."
          docker build -f Dockerfile.training -t ${IMAGE_NAME}:training-${VERSION} -t ${IMAGE_NAME}:training .

          # Serving Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
          echo "üî® Serving Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Ï§ë..."
          docker build -f Dockerfile.serving -t ${IMAGE_NAME}:serving-${VERSION} -t ${IMAGE_NAME}:serving .

          # Training Controller Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
          echo "üî® Training Controller Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Ï§ë..."
          docker build -f training-controller/Dockerfile -t ${IMAGE_NAME}:training-controller-${VERSION} -t ${IMAGE_NAME}:training-controller training-controller/

          # Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ ÌôïÏù∏
          echo "üì¶ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞:"
          docker images | grep ${IMAGE_NAME}

          # tar ÌååÏùºÎ°ú Ï†ÄÏû•
          echo "üíæ Ïù¥ÎØ∏ÏßÄÎ•º tar ÌååÏùºÎ°ú Ï†ÄÏû• Ï§ë..."
          docker save ${IMAGE_NAME}:training-${VERSION} | gzip > training-image.tar.gz
          docker save ${IMAGE_NAME}:serving-${VERSION} | gzip > serving-image.tar.gz
          docker save ${IMAGE_NAME}:training-controller-${VERSION} | gzip > controller-image.tar.gz

      - name: ÏÑúÎ≤ÑÏóê SSH ÌÇ§ ÏÑ§Ï†ï
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏùÑ ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          SSH_PORT=${DEPLOY_PORT:-22}

          echo "üì§ Training Ïù¥ÎØ∏ÏßÄ Ï†ÑÏÜ° Ï§ë..."
          scp -P ${SSH_PORT} -o StrictHostKeyChecking=no training-image.tar.gz ${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/

          echo "üì§ Serving Ïù¥ÎØ∏ÏßÄ Ï†ÑÏÜ° Ï§ë..."
          scp -P ${SSH_PORT} -o StrictHostKeyChecking=no serving-image.tar.gz ${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/

          echo "üì§ Training Controller Ïù¥ÎØ∏ÏßÄ Ï†ÑÏÜ° Ï§ë..."
          scp -P ${SSH_PORT} -o StrictHostKeyChecking=no controller-image.tar.gz ${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/

          echo "üì§ Kubernetes Îß§ÎãàÌéòÏä§Ìä∏ Ï†ÑÏÜ° Ï§ë..."
          scp -r -P ${SSH_PORT} -o StrictHostKeyChecking=no k8s/ ${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/

      - name: KubernetesÏóê Î∞∞Ìè¨
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          VERSION: ${{ github.event.release.tag_name }}
        run: |
          SSH_PORT=${DEPLOY_PORT:-22}

          # SSH Keep-Alive ÏÑ§Ï†ïÏúºÎ°ú Ïó∞Í≤∞ Ïú†ÏßÄ
          ssh -p ${SSH_PORT} \
            -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=30 \
            -o ServerAliveCountMax=10 \
            ${DEPLOY_USER}@${DEPLOY_HOST} << 'EOF'
            set -e
            
            VERSION="${{ env.VERSION }}"
            
            echo "======================================"
            echo "Kubernetes Î∞∞Ìè¨ ÏãúÏûë"
            echo "Î≤ÑÏ†Ñ: ${VERSION}"
            echo "======================================"
            
            # 1. Docker Ïù¥ÎØ∏ÏßÄÎ•º k3sÏóê import
            echo ""
            echo "üì• [1/5] Docker Ïù¥ÎØ∏ÏßÄÎ•º k3sÏóê import..."
            
            docker load < /tmp/training-image.tar.gz
            docker load < /tmp/serving-image.tar.gz
            docker load < /tmp/controller-image.tar.gz
            
            k3s ctr images import /tmp/training-image.tar.gz 2>/dev/null || true
            k3s ctr images import /tmp/serving-image.tar.gz 2>/dev/null || true
            k3s ctr images import /tmp/controller-image.tar.gz 2>/dev/null || true
            
            rm /tmp/training-image.tar.gz /tmp/serving-image.tar.gz /tmp/controller-image.tar.gz
            echo "‚úÖ Ïù¥ÎØ∏ÏßÄ import ÏôÑÎ£å"
            
            # 2. ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§ ÏÉùÏÑ± (ÏóÜÏúºÎ©¥)
            echo ""
            echo "üèóÔ∏è  [2/5] ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§ ÌôïÏù∏..."
            kubectl apply -f /tmp/k8s/01-namespaces.yaml
            echo "‚úÖ ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§ Ï§ÄÎπÑ ÏôÑÎ£å"
            
            # 3. Ïä§ÌÜ†Î¶¨ÏßÄ ÏÑ§Ï†ï (ÏóÜÏúºÎ©¥)
            echo ""
            echo "üíæ [3/5] Ïä§ÌÜ†Î¶¨ÏßÄ ÌôïÏù∏..."
            
            # Ìò∏Ïä§Ìä∏ ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
            mkdir -p /data/mlops
            # chmod 777 /data/mlops
            
            kubectl apply -f /tmp/k8s/02-storage.yaml
            echo "‚úÖ Ïä§ÌÜ†Î¶¨ÏßÄ Ï§ÄÎπÑ ÏôÑÎ£å"
            
            # 4. MLflow ÏÑúÎ≤Ñ Î∞∞Ìè¨/ÏóÖÎç∞Ïù¥Ìä∏
            echo ""
            echo "üìä [4/5] MLflow ÏÑúÎ≤Ñ Î∞∞Ìè¨/ÏóÖÎç∞Ïù¥Ìä∏..."
            kubectl apply -f /tmp/k8s/03-mlflow.yaml
            
            # MLflow Ï§ÄÎπÑ ÎåÄÍ∏∞ (Î∞±Í∑∏ÎùºÏö¥ÎìúÏóêÏÑú ÌôïÏù∏)
            echo "   ‚Üí MLflow ÏÑúÎ≤Ñ Ï§ÄÎπÑ ÌôïÏù∏ Ï§ë..."
            for i in {1..30}; do
              STATUS=$(kubectl get pods -n mlops-training -l app=mlflow-server -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "Unknown")
              if [ "$STATUS" = "Running" ]; then
                echo "‚úÖ MLflow ÏÑúÎ≤Ñ Ï§ÄÎπÑ ÏôÑÎ£å"
                break
              fi
              echo "   ÏÉÅÌÉú: $STATUS (${i}/30)"
              sleep 10
            done
            
            # 5. Training Controller Î∞∞Ìè¨/ÏóÖÎç∞Ïù¥Ìä∏
            echo ""
            echo "üéØ [5/6] Training Controller Î∞∞Ìè¨/ÏóÖÎç∞Ïù¥Ìä∏..."
            kubectl apply -f /tmp/k8s/06-training-controller.yaml
            
            # Training Controller Ï§ÄÎπÑ ÎåÄÍ∏∞
            echo "   ‚Üí Training Controller Ï§ÄÎπÑ ÌôïÏù∏ Ï§ë..."
            for i in {1..30}; do
              STATUS=$(kubectl get pods -n mlops-training -l app=training-controller -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "Unknown")
              if [ "$STATUS" = "Running" ]; then
                echo "‚úÖ Training Controller Ï§ÄÎπÑ ÏôÑÎ£å"
                break
              fi
              echo "   ÏÉÅÌÉú: $STATUS (${i}/30)"
              sleep 10
            done
            
            # 6. ÏÑúÎπô API Î¨¥Ï§ëÎã® Î∞∞Ìè¨
            echo ""
            echo "üöÄ [6/6] ÏÑúÎπô API Î¨¥Ï§ëÎã® Î∞∞Ìè¨..."
            kubectl apply -f /tmp/k8s/05-serving.yaml
            
            # Î°§ÏïÑÏõÉ ÏãúÏûë
            echo "   ‚Üí Î°§ÎßÅ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë..."
            kubectl set image deployment/iris-serving \
              serving=ops-demo:serving \
              -n mlops-serving || true
            
            # Î°§ÏïÑÏõÉ ÏßÑÌñâ ÏÉÅÌô© ÌôïÏù∏ (Î∞±Í∑∏ÎùºÏö¥ÎìúÏóêÏÑú ÌôïÏù∏)
            echo "   ‚Üí ÏÑúÎπô API Ï§ÄÎπÑ ÌôïÏù∏ Ï§ë..."
            for i in {1..30}; do
              READY=$(kubectl get deployment iris-serving -n mlops-serving -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
              DESIRED=$(kubectl get deployment iris-serving -n mlops-serving -o jsonpath='{.status.replicas}' 2>/dev/null || echo "2")
              if [ "$READY" = "$DESIRED" ] && [ "$READY" != "0" ]; then
                echo "‚úÖ ÏÑúÎπô API Î∞∞Ìè¨ ÏôÑÎ£å ($READY/$DESIRED)"
                break
              fi
              echo "   ÏÉÅÌÉú: $READY/$DESIRED (${i}/30)"
              sleep 10
            done
            
            # Ï†ïÎ¶¨
            rm -rf /tmp/k8s
            
            echo ""
            echo "======================================"
            echo "‚úÖ Î∞∞Ìè¨ ÏôÑÎ£å!"
            echo "======================================"
          EOF

      - name: Î∞∞Ìè¨ Í≤∞Í≥º ÌôïÏù∏
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          SSH_PORT=${DEPLOY_PORT:-22}

          # SSH Keep-Alive ÏÑ§Ï†ï
          ssh -p ${SSH_PORT} \
            -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=30 \
            -o ServerAliveCountMax=10 \
            ${DEPLOY_USER}@${DEPLOY_HOST} << 'EOF'
            echo ""
            echo "======================================"
            echo "Î∞∞Ìè¨ ÏÉÅÌÉú ÌôïÏù∏"
            echo "======================================"
            
            echo ""
            echo "üìä Training ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§:"
            kubectl get pods,svc -n mlops-training
            
            echo ""
            echo "üöÄ Serving ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§:"
            kubectl get pods,svc -n mlops-serving
            
            echo ""
            echo "üìù ÏµúÍ∑º Î°úÍ∑∏ (Serving API):"
            SERVING_POD=$(kubectl get pod -n mlops-serving -l app=iris-serving -o jsonpath='{.items[0].metadata.name}')
            kubectl logs --tail=20 $SERVING_POD -n mlops-serving 2>/dev/null || echo "Î°úÍ∑∏Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§."
            
            echo ""
            echo "======================================"
            echo "Ï†ëÏÜç Ï†ïÎ≥¥"
            echo "======================================"
            
            # External IP ÌôïÏù∏
            EXTERNAL_IP=$(kubectl get svc iris-serving-service -n mlops-serving -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
            
            if [ "$EXTERNAL_IP" != "pending" ] && [ -n "$EXTERNAL_IP" ]; then
              echo "üöÄ Serving API: http://$EXTERNAL_IP"
            else
              echo "üöÄ Serving API: Ìè¨Ìä∏Ìè¨ÏõåÎî© ÌïÑÏöî"
              echo "   kubectl port-forward -n mlops-serving svc/iris-serving-service 8000:80"
            fi
            
            echo ""
            MLflow_POD=$(kubectl get pod -n mlops-training -l app=mlflow-server -o jsonpath='{.items[0].metadata.name}')
            echo "üìä MLflow UI: Ìè¨Ìä∏Ìè¨ÏõåÎî© ÌïÑÏöî"
            echo "   kubectl port-forward -n mlops-training $MLFLOW_POD 5000:5000"
          EOF

      - name: Î∞∞Ìè¨ Í≤∞Í≥º ÏöîÏïΩ
        env:
          VERSION: ${{ github.event.release.tag_name }}
        run: |
          echo "## üéâ Kubernetes Î∞∞Ìè¨ ÏÑ±Í≥µ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Î∞∞Ìè¨ Ï†ïÎ≥¥" >> $GITHUB_STEP_SUMMARY
          echo "- **Î≤ÑÏ†Ñ**: ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **ÏÑúÎ≤Ñ**: ${{ secrets.DEPLOY_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ïª§Î∞ã**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üê≥ Î∞∞Ìè¨Îêú Ïù¥ÎØ∏ÏßÄ" >> $GITHUB_STEP_SUMMARY
          echo "- \`ops-demo:training-${VERSION}\` (ÌõàÎ†®Ïö©)" >> $GITHUB_STEP_SUMMARY
          echo "- \`ops-demo:serving-${VERSION}\` (ÏÑúÎπôÏö©)" >> $GITHUB_STEP_SUMMARY
          echo "- \`ops-demo:training-controller-${VERSION}\` (ÌõàÎ†® UI)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üöÄ Î∞∞Ìè¨Îêú Î¶¨ÏÜåÏä§" >> $GITHUB_STEP_SUMMARY
          echo "- Training Controller UI (mlops-training)" >> $GITHUB_STEP_SUMMARY
          echo "- MLflow Server (mlops-training)" >> $GITHUB_STEP_SUMMARY
          echo "- Serving API x2 (mlops-serving)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Ï†ëÏÜç Î∞©Î≤ï" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Training Controller UI (ÏõπÏóêÏÑú ÌõàÎ†® ÏãúÏûë)" >> $GITHUB_STEP_SUMMARY
          echo "kubectl port-forward -n mlops-training svc/training-controller-service 8080:8080" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# MLflow UI (Ïã§Ìóò Ï∂îÏ†Å)" >> $GITHUB_STEP_SUMMARY
          echo "kubectl port-forward -n mlops-training svc/mlflow-service 5000:5000" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Serving API" >> $GITHUB_STEP_SUMMARY
          echo "kubectl port-forward -n mlops-serving svc/iris-serving-service 8000:80" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìù Î¶¥Î¶¨Ïä§ ÎÖ∏Ìä∏" >> $GITHUB_STEP_SUMMARY
          echo "${{ github.event.release.body }}" >> $GITHUB_STEP_SUMMARY
