name: CD Pipeline

on:
  release:
    types: [published]

env:
  IMAGE_NAME: ops-demo

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ (Training & Serving & Controller)
        run: |
          VERSION=${{ github.event.release.tag_name }}

          # Training ì´ë¯¸ì§€ ë¹Œë“œ
          echo "ğŸ”¨ Training ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
          docker build -f Dockerfile.training -t ${IMAGE_NAME}:training-${VERSION} -t ${IMAGE_NAME}:training .

          # Serving ì´ë¯¸ì§€ ë¹Œë“œ
          echo "ğŸ”¨ Serving ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
          docker build -f Dockerfile.serving -t ${IMAGE_NAME}:serving-${VERSION} -t ${IMAGE_NAME}:serving .

          # Training Controller ì´ë¯¸ì§€ ë¹Œë“œ
          echo "ğŸ”¨ Training Controller ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
          docker build -f training-controller/Dockerfile -t ${IMAGE_NAME}:training-controller-${VERSION} -t ${IMAGE_NAME}:training-controller training-controller/

          # ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
          echo "ğŸ“¦ ì´ë¯¸ì§€ í¬ê¸°:"
          docker images | grep ${IMAGE_NAME}

          # tar íŒŒì¼ë¡œ ì €ì¥
          echo "ğŸ’¾ ì´ë¯¸ì§€ë¥¼ tar íŒŒì¼ë¡œ ì €ì¥ ì¤‘..."
          docker save ${IMAGE_NAME}:training-${VERSION} | gzip > training-image.tar.gz
          docker save ${IMAGE_NAME}:serving-${VERSION} | gzip > serving-image.tar.gz
          docker save ${IMAGE_NAME}:training-controller-${VERSION} | gzip > controller-image.tar.gz

      - name: ì„œë²„ì— SSH í‚¤ ì„¤ì •
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ì´ë¯¸ì§€ íŒŒì¼ì„ ì„œë²„ë¡œ ì „ì†¡
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          SSH_PORT=${DEPLOY_PORT:-22}

          echo "ğŸ“¤ Training ì´ë¯¸ì§€ ì „ì†¡ ì¤‘..."
          scp -P ${SSH_PORT} -o StrictHostKeyChecking=no training-image.tar.gz ${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/

          echo "ğŸ“¤ Serving ì´ë¯¸ì§€ ì „ì†¡ ì¤‘..."
          scp -P ${SSH_PORT} -o StrictHostKeyChecking=no serving-image.tar.gz ${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/

          echo "ğŸ“¤ Training Controller ì´ë¯¸ì§€ ì „ì†¡ ì¤‘..."
          scp -P ${SSH_PORT} -o StrictHostKeyChecking=no controller-image.tar.gz ${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/

          echo "ğŸ“¤ Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì „ì†¡ ì¤‘..."
          scp -r -P ${SSH_PORT} -o StrictHostKeyChecking=no k8s/ ${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/

      - name: Kubernetesì— ë°°í¬
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          VERSION: ${{ github.event.release.tag_name }}
        run: |
          SSH_PORT=${DEPLOY_PORT:-22}

          ssh -p ${SSH_PORT} -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} << 'EOF'
            set -e
            
            VERSION="${{ env.VERSION }}"
            
            echo "======================================"
            echo "Kubernetes ë°°í¬ ì‹œì‘"
            echo "ë²„ì „: ${VERSION}"
            echo "======================================"
            
            # 1. Docker ì´ë¯¸ì§€ë¥¼ k3sì— import
            echo ""
            echo "ğŸ“¥ [1/5] Docker ì´ë¯¸ì§€ë¥¼ k3sì— import..."
            
            docker load < /tmp/training-image.tar.gz
            docker load < /tmp/serving-image.tar.gz
            docker load < /tmp/controller-image.tar.gz
            
            k3s ctr images import /tmp/training-image.tar.gz 2>/dev/null || true
            k3s ctr images import /tmp/serving-image.tar.gz 2>/dev/null || true
            k3s ctr images import /tmp/controller-image.tar.gz 2>/dev/null || true
            
            rm /tmp/training-image.tar.gz /tmp/serving-image.tar.gz /tmp/controller-image.tar.gz
            echo "âœ… ì´ë¯¸ì§€ import ì™„ë£Œ"
            
            # 2. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± (ì—†ìœ¼ë©´)
            echo ""
            echo "ğŸ—ï¸  [2/5] ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸..."
            kubectl apply -f /tmp/k8s/01-namespaces.yaml
            echo "âœ… ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì¤€ë¹„ ì™„ë£Œ"
            
            # 3. ìŠ¤í† ë¦¬ì§€ ì„¤ì • (ì—†ìœ¼ë©´)
            echo ""
            echo "ğŸ’¾ [3/5] ìŠ¤í† ë¦¬ì§€ í™•ì¸..."
            
            # í˜¸ìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p /data/mlops
            chmod 777 /data/mlops
            
            kubectl apply -f /tmp/k8s/02-storage.yaml
            echo "âœ… ìŠ¤í† ë¦¬ì§€ ì¤€ë¹„ ì™„ë£Œ"
            
            # 4. MLflow ì„œë²„ ë°°í¬/ì—…ë°ì´íŠ¸
            echo ""
            echo "ğŸ“Š [4/5] MLflow ì„œë²„ ë°°í¬/ì—…ë°ì´íŠ¸..."
            kubectl apply -f /tmp/k8s/03-mlflow.yaml
            
            # MLflow ì¤€ë¹„ ëŒ€ê¸°
            echo "   â†’ MLflow ì„œë²„ ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
            kubectl wait --for=condition=ready pod -l app=mlflow-server -n mlops-training --timeout=120s || true
            echo "âœ… MLflow ì„œë²„ ì¤€ë¹„ ì™„ë£Œ"
            
            # 5. Training Controller ë°°í¬/ì—…ë°ì´íŠ¸
            echo ""
            echo "ğŸ¯ [5/5] Training Controller ë°°í¬/ì—…ë°ì´íŠ¸..."
            kubectl apply -f /tmp/k8s/06-training-controller.yaml
            
            # Training Controller ì¤€ë¹„ ëŒ€ê¸°
            echo "   â†’ Training Controller ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
            kubectl wait --for=condition=ready pod -l app=training-controller -n mlops-training --timeout=120s || true
            echo "âœ… Training Controller ì¤€ë¹„ ì™„ë£Œ"
            
            # 6. ì„œë¹™ API ë¬´ì¤‘ë‹¨ ë°°í¬
            echo ""
            echo "ğŸš€ [6/6] ì„œë¹™ API ë¬´ì¤‘ë‹¨ ë°°í¬..."
            kubectl apply -f /tmp/k8s/05-serving.yaml
            
            # ë¡¤ì•„ì›ƒ ì‹œì‘
            echo "   â†’ ë¡¤ë§ ì—…ë°ì´íŠ¸ ì‹œì‘..."
            kubectl set image deployment/iris-serving \
              serving=ops-demo:serving \
              -n mlops-serving
            
            # ë¡¤ì•„ì›ƒ ì§„í–‰ ìƒí™© í™•ì¸
            kubectl rollout status deployment/iris-serving -n mlops-serving --timeout=180s
            echo "âœ… ì„œë¹™ API ë°°í¬ ì™„ë£Œ"
            
            # ì •ë¦¬
            rm -rf /tmp/k8s
            
            echo ""
            echo "======================================"
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo "======================================"
          EOF

      - name: ë°°í¬ ê²°ê³¼ í™•ì¸
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          SSH_PORT=${DEPLOY_PORT:-22}

          ssh -p ${SSH_PORT} -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} << 'EOF'
            echo ""
            echo "======================================"
            echo "ë°°í¬ ìƒíƒœ í™•ì¸"
            echo "======================================"
            
            echo ""
            echo "ğŸ“Š Training ë„¤ì„ìŠ¤í˜ì´ìŠ¤:"
            kubectl get pods,svc -n mlops-training
            
            echo ""
            echo "ğŸš€ Serving ë„¤ì„ìŠ¤í˜ì´ìŠ¤:"
            kubectl get pods,svc -n mlops-serving
            
            echo ""
            echo "ğŸ“ ìµœê·¼ ë¡œê·¸ (Serving API):"
            SERVING_POD=$(kubectl get pod -n mlops-serving -l app=iris-serving -o jsonpath='{.items[0].metadata.name}')
            kubectl logs --tail=20 $SERVING_POD -n mlops-serving 2>/dev/null || echo "ë¡œê·¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            
            echo ""
            echo "======================================"
            echo "ì ‘ì† ì •ë³´"
            echo "======================================"
            
            # External IP í™•ì¸
            EXTERNAL_IP=$(kubectl get svc iris-serving-service -n mlops-serving -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
            
            if [ "$EXTERNAL_IP" != "pending" ] && [ -n "$EXTERNAL_IP" ]; then
              echo "ğŸš€ Serving API: http://$EXTERNAL_IP"
            else
              echo "ğŸš€ Serving API: í¬íŠ¸í¬ì›Œë”© í•„ìš”"
              echo "   kubectl port-forward -n mlops-serving svc/iris-serving-service 8000:80"
            fi
            
            echo ""
            MLflow_POD=$(kubectl get pod -n mlops-training -l app=mlflow-server -o jsonpath='{.items[0].metadata.name}')
            echo "ğŸ“Š MLflow UI: í¬íŠ¸í¬ì›Œë”© í•„ìš”"
            echo "   kubectl port-forward -n mlops-training $MLFLOW_POD 5000:5000"
          EOF

      - name: ë°°í¬ ê²°ê³¼ ìš”ì•½
        env:
          VERSION: ${{ github.event.release.tag_name }}
        run: |
          echo "## ğŸ‰ Kubernetes ë°°í¬ ì„±ê³µ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ ë°°í¬ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- **ë²„ì „**: ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì„œë²„**: ${{ secrets.DEPLOY_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ³ ë°°í¬ëœ ì´ë¯¸ì§€" >> $GITHUB_STEP_SUMMARY
          echo "- \`ops-demo:training-${VERSION}\` (í›ˆë ¨ìš©)" >> $GITHUB_STEP_SUMMARY
          echo "- \`ops-demo:serving-${VERSION}\` (ì„œë¹™ìš©)" >> $GITHUB_STEP_SUMMARY
          echo "- \`ops-demo:training-controller-${VERSION}\` (í›ˆë ¨ UI)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ ë°°í¬ëœ ë¦¬ì†ŒìŠ¤" >> $GITHUB_STEP_SUMMARY
          echo "- Training Controller UI (mlops-training)" >> $GITHUB_STEP_SUMMARY
          echo "- MLflow Server (mlops-training)" >> $GITHUB_STEP_SUMMARY
          echo "- Serving API x2 (mlops-serving)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š ì ‘ì† ë°©ë²•" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Training Controller UI (ì›¹ì—ì„œ í›ˆë ¨ ì‹œì‘)" >> $GITHUB_STEP_SUMMARY
          echo "kubectl port-forward -n mlops-training svc/training-controller-service 8080:8080" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# MLflow UI (ì‹¤í—˜ ì¶”ì )" >> $GITHUB_STEP_SUMMARY
          echo "kubectl port-forward -n mlops-training svc/mlflow-service 5000:5000" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Serving API" >> $GITHUB_STEP_SUMMARY
          echo "kubectl port-forward -n mlops-serving svc/iris-serving-service 8000:80" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "${{ github.event.release.body }}" >> $GITHUB_STEP_SUMMARY
