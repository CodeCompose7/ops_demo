name: CD Pipeline

on:
  release:
    types: [published]

env:
  IMAGE_NAME: ops-demo

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Docker ì´ë¯¸ì§€ë¥¼ tar íŒŒì¼ë¡œ ì €ì¥
        run: |
          # Release íƒœê·¸ë¥¼ ë²„ì „ìœ¼ë¡œ ì‚¬ìš©
          VERSION=${{ github.event.release.tag_name }}
          docker build -t ${{ env.IMAGE_NAME }}:${VERSION} -t ${{ env.IMAGE_NAME }}:latest .
          docker save ${{ env.IMAGE_NAME }}:${VERSION} | gzip > image.tar.gz

      - name: ì„œë²„ì— SSH í‚¤ ì„¤ì •
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ì„œë²„ì— ë°°í¬
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          APP_PORT: ${{ secrets.APP_PORT }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          VERSION: ${{ github.event.release.tag_name }}
        run: |
          # SSH í¬íŠ¸ ì„¤ì • (ê¸°ë³¸ê°’: 22)
          SSH_PORT=${DEPLOY_PORT:-22}
          # ì• í”Œë¦¬ì¼€ì´ì…˜ í¬íŠ¸ ì„¤ì • (ê¸°ë³¸ê°’: 8000)
          HOST_PORT=${APP_PORT:-8000}

          # ì´ë¯¸ì§€ íŒŒì¼ì„ ì„œë²„ë¡œ ì „ì†¡
          scp -P ${SSH_PORT} -o StrictHostKeyChecking=no image.tar.gz ${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/

          # ì„œë²„ì—ì„œ ì´ë¯¸ì§€ ë¡œë“œ ë° ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
          ssh -p ${SSH_PORT} -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} << EOF
            # ê¸°ì¡´ ì´ë¯¸ì§€ ë¡œë“œ
            docker load < /tmp/image.tar.gz
            rm /tmp/image.tar.gz
            
            # ì´ë¯¸ì§€ íƒœê·¸ ì„¤ì •
            IMAGE_TAG=${IMAGE_NAME}:${VERSION}
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
            docker stop ops_demo || true
            docker rm ops_demo || true
            
            # ìƒˆ ì´ë¯¸ì§€ë¡œ ì»¨í…Œì´ë„ˆ ì‹œì‘ (í˜¸ìŠ¤íŠ¸ í¬íŠ¸: ${HOST_PORT}, ì»¨í…Œì´ë„ˆ í¬íŠ¸: 8000)
            docker run -d \
              --name ops_demo \
              -p ${HOST_PORT}:8000 \
              -e ENVIRONMENT=production \
              -e LOG_LEVEL=info \
              --restart unless-stopped \
              \${IMAGE_TAG}
            
            # ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f
          EOF

      - name: ë°°í¬ ê²°ê³¼ í™•ì¸
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          # SSH í¬íŠ¸ ì„¤ì • (ê¸°ë³¸ê°’: 22)
          SSH_PORT=${DEPLOY_PORT:-22}
          ssh -p ${SSH_PORT} -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} << 'EOF'
            echo "--- ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ---"
            docker ps --filter "name=ops_demo" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            echo ""
            echo "--- ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 20ì¤„) ---"
            docker logs --tail=20 ops_demo || echo "ì»¨í…Œì´ë„ˆê°€ ì•„ì§ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          EOF

      - name: ë°°í¬ ê²°ê³¼ ìš”ì•½
        env:
          APP_PORT: ${{ secrets.APP_PORT }}
        run: |
          HOST_PORT=${APP_PORT:-8000}
          echo "## ë°°í¬ ì„±ê³µ ğŸš€" >> $GITHUB_STEP_SUMMARY
          echo "**ë²„ì „**: ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "ì„œë²„: ${{ secrets.DEPLOY_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "í¬íŠ¸: ${HOST_PORT}" >> $GITHUB_STEP_SUMMARY
          echo "ì»¤ë°‹: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸: ${{ github.event.release.body }}" >> $GITHUB_STEP_SUMMARY
