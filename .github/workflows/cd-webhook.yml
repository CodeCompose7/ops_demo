name: CD Pipeline (Webhook)

on:
  release:
    types: [published]

env:
  IMAGE_NAME: ops-demo

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ì„œë²„ì— SSH í‚¤ ì„¤ì •
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ì„œë²„ì— ë°°í¬ íŠ¸ë¦¬ê±°
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          VERSION: ${{ github.event.release.tag_name }}
        run: |
          SSH_PORT=${DEPLOY_PORT:-22}

          # ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          ssh -p ${SSH_PORT} \
            -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=30 \
            -o ServerAliveCountMax=10 \
            ${DEPLOY_USER}@${DEPLOY_HOST} << 'EOF'
            
            set -e
            
            VERSION="${{ env.VERSION }}"
            
            echo "======================================"
            echo "ì„œë²„ì—ì„œ ì§ì ‘ ë¹Œë“œ ë° ë°°í¬"
            echo "ë²„ì „: ${VERSION}"
            echo "======================================"
            
            # 1. Git ì €ì¥ì†Œ ì—…ë°ì´íŠ¸
            echo ""
            echo "ğŸ“¥ [1/4] Git ì €ì¥ì†Œ ì—…ë°ì´íŠ¸..."
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì„¤ì • (í™ˆ ë””ë ‰í† ë¦¬ ì‚¬ìš©)
            PROJECT_DIR="$HOME/ops-demo"
            
            # ì €ì¥ì†Œê°€ ì—†ìœ¼ë©´ clone
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "  â†’ ì €ì¥ì†Œ clone ì¤‘..."
              git clone https://github.com/${{ github.repository }}.git $PROJECT_DIR
            fi
            
            cd $PROJECT_DIR
            
            # í•­ìƒ ìµœì‹  ìƒíƒœë¡œ ì—…ë°ì´íŠ¸ (íƒœê·¸ í¬í•¨)
            echo "  â†’ ìµœì‹  ì½”ë“œ ë° íƒœê·¸ ê°€ì ¸ì˜¤ê¸°..."
            git fetch --all --tags --prune --force
            
            # Release íƒœê·¸ë¡œ ê°•ì œ ì „í™˜
            echo "  â†’ Release ${VERSION}ë¡œ ì „í™˜ ì¤‘..."
            if git rev-parse ${VERSION} >/dev/null 2>&1; then
              git checkout -f ${VERSION}
              echo "  âœ“ Release ${VERSION} ì ìš©"
            else
              echo "  âš  íƒœê·¸ ${VERSION}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ, main ì‚¬ìš©"
              git checkout -f main
              git reset --hard origin/main
            fi
            
            echo "  â†’ í˜„ì¬ ì»¤ë°‹: $(git rev-parse --short HEAD)"
            echo "âœ… ì½”ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
            
            # 2. Docker ì´ë¯¸ì§€ ë¹Œë“œ
            echo ""
            echo "ğŸ”¨ [2/4] Docker ì´ë¯¸ì§€ ë¹Œë“œ..."
            
            docker build -f Dockerfile.training -t ops-demo:training-${VERSION} .
            docker tag ops-demo:training-${VERSION} ops-demo:training
            echo "  âœ“ Training ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
            
            docker build -f Dockerfile.serving -t ops-demo:serving-${VERSION} .
            docker tag ops-demo:serving-${VERSION} ops-demo:serving
            echo "  âœ“ Serving ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
            
            docker build -f training-controller/Dockerfile -t ops-demo:training-controller-${VERSION} training-controller/
            docker tag ops-demo:training-controller-${VERSION} ops-demo:training-controller
            echo "  âœ“ Training Controller ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
            
            # 3. k3sì— ì´ë¯¸ì§€ import
            echo ""
            echo "ğŸ“¦ [3/4] k3sì— ì´ë¯¸ì§€ import..."
            
            # k3s ê·¸ë£¹ì— ì†í•œ ì‚¬ìš©ìëŠ” sudo ì—†ì´ ì‹¤í–‰ ê°€ëŠ¥
            docker save ops-demo:training-${VERSION} | k3s ctr images import - 2>/dev/null || \
              docker save ops-demo:training-${VERSION} | sudo k3s ctr images import - 2>/dev/null || true
            
            docker save ops-demo:serving-${VERSION} | k3s ctr images import - 2>/dev/null || \
              docker save ops-demo:serving-${VERSION} | sudo k3s ctr images import - 2>/dev/null || true
            
            docker save ops-demo:training-controller-${VERSION} | k3s ctr images import - 2>/dev/null || \
              docker save ops-demo:training-controller-${VERSION} | sudo k3s ctr images import - 2>/dev/null || true
            
            echo "âœ… ì´ë¯¸ì§€ import ì™„ë£Œ"
            
            # 4. Kubernetes ë°°í¬
            echo ""
            echo "ğŸš€ [4/4] Kubernetes ë°°í¬..."
            
            cd $PROJECT_DIR/k8s
            
            # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸
            kubectl apply -f 01-namespaces.yaml
            
            # ìŠ¤í† ë¦¬ì§€ ë””ë ‰í† ë¦¬ ì„¤ì • (ì‚¬ìš©ì í™ˆ ë””ë ‰í† ë¦¬)
            STORAGE_DIR="$HOME/ops-demo-data/mlops"
            if [ ! -d "$STORAGE_DIR" ]; then
              echo "  â†’ ìŠ¤í† ë¦¬ì§€ ë””ë ‰í† ë¦¬ ìƒì„±: $STORAGE_DIR"
              mkdir -p $STORAGE_DIR
            fi
            
            # PersistentVolumeì˜ hostPathë¥¼ ì‹¤ì œ ê²½ë¡œë¡œ ì¹˜í™˜í•˜ì—¬ ì ìš©
            sed "s|/data/mlops|$STORAGE_DIR|g" 02-storage.yaml | kubectl apply -f -
            
            # MLflow ë°°í¬ (ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸)
            kubectl set image deployment/mlflow-server mlflow=ops-demo:training-${VERSION} -n mlops-training
            kubectl apply -f 03-mlflow.yaml
            echo "  âœ“ MLflow ë°°í¬ ì™„ë£Œ"
            
            # Training Controller ë°°í¬ (ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸)
            kubectl set image deployment/training-controller controller=ops-demo:training-controller-${VERSION} -n mlops-training
            kubectl apply -f 06-training-controller.yaml
            echo "  âœ“ Training Controller ë°°í¬ ì™„ë£Œ"
            
            # Serving API ë¬´ì¤‘ë‹¨ ë°°í¬ (ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸)
            kubectl set image deployment/iris-serving serving=ops-demo:serving-${VERSION} -n mlops-serving
            kubectl apply -f 05-serving.yaml
            echo "  âœ“ Serving API ë°°í¬ ì™„ë£Œ"
            
            echo ""
            echo "======================================"
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo "======================================"
            echo ""
            
            # ìƒíƒœ í™•ì¸
            echo "Pod ìƒíƒœ:"
            kubectl get pods -n mlops-training
            kubectl get pods -n mlops-serving
            echo ""
            
            echo "ì„œë¹„ìŠ¤ ìƒíƒœ:"
            kubectl get svc -n mlops-training
            kubectl get svc -n mlops-serving
            
          EOF

      - name: ë°°í¬ ê²°ê³¼ ìš”ì•½
        env:
          VERSION: ${{ github.event.release.tag_name }}
        run: |
          echo "## ğŸ‰ ë°°í¬ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ ë°°í¬ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- **ë²„ì „**: ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì„œë²„**: ${{ secrets.DEPLOY_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë°©ì‹**: ì„œë²„ì—ì„œ ì§ì ‘ ë¹Œë“œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ ì ‘ì† ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- Training Controller: http://localhost:30081" >> $GITHUB_STEP_SUMMARY
          echo "- MLflow UI: http://localhost:30501" >> $GITHUB_STEP_SUMMARY
          echo "- Serving API: http://localhost:30801" >> $GITHUB_STEP_SUMMARY
