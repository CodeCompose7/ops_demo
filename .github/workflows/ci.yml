name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Python ${{ matrix.python-version }} ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: ì˜ì¡´ì„± ìºì‹±
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ (flake8)
        run: |
          pip install flake8
          # í”„ë¡œì íŠ¸ì˜ Python íŒŒì¼ë“¤ì— ëŒ€í•´ ë¬¸ë²• ì—ëŸ¬ì™€ undefined names ì²´í¬
          flake8 app tests --count --select=E9,F63,F7,F82 --show-source --statistics || true
          # ë³µì¡ë„ ì²´í¬ (ì„ íƒì‚¬í•­)
          flake8 app tests --count --exit-zero --max-complexity=10 --statistics || true
        continue-on-error: true

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€ ì¸¡ì •
        run: |
          pytest tests/ -v --cov=app --cov-report=term-missing --cov-report=xml

      - name: ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: codecov/codecov-action@v3
        if: matrix.python-version == '3.11'
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "## í…ŒìŠ¤íŠ¸ ê²°ê³¼ ğŸ§ª" >> $GITHUB_STEP_SUMMARY
          echo "Python ë²„ì „: ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
          echo "ìƒíƒœ: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  lint:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Ruff ë¦°í„° ì‹¤í–‰
        run: |
          pip install ruff
          ruff check app tests || true
        continue-on-error: true
